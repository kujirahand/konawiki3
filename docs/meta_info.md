# メタ情報について

KonaWiki 3 では、ページのメタ情報（タグ情報など）を各ページごとに保存する方式を採用しています。メタ情報は、ページの内容とは別に管理され、ページの編集や表示に影響を与えません。

`data/.meta/{タイトル}.json` ファイルには、ページに関連するメタ情報がJSON形式で保存されます。例えば、以下のような情報が保存されます。

```json
{
    "page_id": 123,
    "page": "PageName",
    "tags": ["PHP", "プログラミング", "Web開発"],
    "created_at": 1625078400,
    "updated_at": 1625164800
}
```

## メタ情報の実装

### ファイル構造

メタ情報は、各ページに対応する `data/.meta/{タイトル}.json` ファイルとして保存されます。階層を持つページの場合、メタ情報ファイルも同様の階層構造を持ちます。

```text
data/
  |- category/
  |    |- page1.txt
  |- page2.md
  |- .meta/
      |- category/
      |    |- page1.json
      |- page2.json
```

### API関数

`kona3db.inc.php` に以下の関数が実装されています：

#### kona3db_savePageMeta($page, $meta)

ページのメタ情報を保存します。

- **引数**:
  - `$page`: ページ名（文字列）
  - `$meta`: メタ情報の配列
- **戻り値**: 成功時に `TRUE`、失敗時に `FALSE`
- **機能**:
  - ページIDを自動的に取得・設定
  - `created_at` と `updated_at` タイムスタンプを自動管理
  - ディレクトリが存在しない場合は自動作成

**使用例**:

```php
$meta = [
    'tags' => ['PHP', 'Web開発'],
    'description' => 'ページの説明',
];
kona3db_savePageMeta('PageName', $meta);
```

#### kona3db_loadPageMeta($page)

ページのメタ情報を読み込みます。

- **引数**: `$page`: ページ名（文字列）
- **戻り値**: メタ情報の配列、存在しない場合は `null`

**使用例**:
```php
$meta = kona3db_loadPageMeta('PageName');
if ($meta !== null) {
    $tags = $meta['tags'];
    // タグを処理...
}
```

#### kona3db_getPageMetaFile($page)

ページのメタ情報ファイルのパスを取得します。

- **引数**: `$page`: ページ名（文字列）
- **戻り値**: メタ情報ファイルの絶対パス（文字列）

### 自動保存

ページの編集時（`edit.inc.php` の `kona3_trywrite` 関数）に、メタ情報が自動的に保存されます：

- タグ情報がフォームから送信された場合、メタ情報に保存
- ページが削除された場合、メタ情報ファイルも削除

### 表示での利用

ページ表示時（`show.inc.php`）および編集時（`edit.inc.php`）に、メタ情報が自動的に読み込まれます：

1. まずメタ情報ファイルから読み込み
2. メタ情報ファイルが存在しない場合は、データベースからフォールバック

## タグシステム

KonaWiki 3 では、タグシステムを使用してページにタグを付与し、関連するページを簡単に検索・表示できます。

- [タグの仕様](docs/TAG_SYSTEM.md)

## 今後の拡張

メタ情報システムは、タグ以外の情報も保存できるよう設計されています。例えば：

- ページの説明文（`description`）
- カスタムフィールド
- ページのステータス
- 関連ページのリンク

など、任意のメタデータを追加することができます。
